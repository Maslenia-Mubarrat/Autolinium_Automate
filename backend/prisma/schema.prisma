generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  EMPLOYEE
}

enum PresenceStatus {
  PRESENT
  ABSENT
}

enum AbsenceInfo {
  INFORMED
  UNINFORMED
  GRANTED
  NOT_GRANTED
}

enum LateStatus {
  TIMELY
  LATE_AUTO
  LATE_INFORMED
  LATE_UNINFORMED
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

enum MeetingStatus {
  ATTENDED
  INFORMED_SKIP
  UNINFORMED_SKIP
}

enum TaskStatus {
  PENDING
  DONE
}

model User {
  id                       Int                       @id @default(autoincrement())
  name                     String
  email                    String                    @unique
  passwordHash             String
  role                     Role                      @default(EMPLOYEE)
  baseSalary               Float                     @default(0)
  createdAt                DateTime                  @default(now())
  
  attendances              Attendance[]
  leaveRequests            LeaveRequest[]
  assignedTasks            ProjectTask[]             @relation("AssignedTasks")
  internalMeetingsAttended InternalMeetingAttendee[]
  clientMeetingsAttended   ClientMeetingAttendee[]
  weeklyReports            WeeklyReport[]
  monthlyKPIs              MonthlyKPI[]
  reviewsGiven             PeerReview[]              @relation("ReviewsGiven")
  reviewsReceived          PeerReview[]              @relation("ReviewsReceived")
}

model Attendance {
  id              Int            @id @default(autoincrement())
  user            User           @relation(fields: [userId], references: [id])
  userId          Int
  recordDate      DateTime       @db.Date
  entryTime       DateTime?
  exitTime        DateTime?
  presenceStatus  PresenceStatus @default(PRESENT)
  absenceInfo     AbsenceInfo?
  lateStatus      LateStatus     @default(TIMELY)
  promiseTime     DateTime?
  workMinutes     Int            @default(0)
  overtimeMinutes Int            @default(0)
  adminOverride   Boolean        @default(false)
}

model LeaveRequest {
  id          Int         @id @default(autoincrement())
  user        User        @relation(fields: [userId], references: [id])
  userId      Int
  startDate   DateTime    @db.Date
  endDate     DateTime    @db.Date
  reason      String
  status      LeaveStatus @default(PENDING)
  requestedAt DateTime    @default(now())
}

model InternalMeeting {
  id          Int                       @id @default(autoincrement())
  name        String
  meetingDate DateTime                  @db.Date
  agenda      String
  createdBy   Int
  attendees   InternalMeetingAttendee[]
}

model InternalMeetingAttendee {
  meeting   InternalMeeting @relation(fields: [meetingId], references: [id])
  meetingId Int
  user      User            @relation(fields: [userId], references: [id])
  userId    Int
  status    MeetingStatus   @default(ATTENDED)

  @@id([meetingId, userId])
}

model ClientMeeting {
  id            Int                     @id @default(autoincrement())
  clientName    String
  scheduledTime DateTime
  createdBy     Int
  attendees     ClientMeetingAttendee[]
}

model ClientMeetingAttendee {
  meeting         ClientMeeting @relation(fields: [meetingId], references: [id])
  meetingId       Int
  user            User          @relation(fields: [userId], references: [id])
  userId          Int
  joinTime        DateTime?
  status          MeetingStatus @default(ATTENDED)
  behaviorPenalty Int           @default(0)

  @@id([meetingId, userId])
}

model PeerReview {
  id                  Int   @id @default(autoincrement())
  reviewer            User  @relation("ReviewsGiven", fields: [reviewerId], references: [id])
  reviewerId          Int
  targetUser          User  @relation("ReviewsReceived", fields: [targetUserId], references: [id])
  targetUserId        Int
  month               Int
  year                Int
  respectScore        Int
  helpfulnessScore    Int
  attitudeScore       Int
  conflictScore       Int
  knowledgeShareScore Int
  averageScore        Float @default(0)
}

model ProjectTask {
  id                     Int        @id @default(autoincrement())
  title                  String
  description            String
  assignedUser           User       @relation("AssignedTasks", fields: [assignedUserId], references: [id])
  assignedUserId         Int
  deadline               DateTime   @db.Date
  completedDate          DateTime?  @db.Date
  status                 TaskStatus @default(PENDING)
  validReason            String?
  informedBeforeDeadline Boolean    @default(false)
  faultDelayDays         Int        @default(0)
}

model WeeklyReport {
  id                    Int      @id @default(autoincrement())
  user                  User     @relation(fields: [userId], references: [id])
  userId                Int
  weekStartDate         DateTime @db.Date
  submittedAt           DateTime @default(now())
  content               String
  missingKnowledgeShare Boolean  @default(false)
}

model MonthlyKPI {
  id                   Int   @id @default(autoincrement())
  user                 User  @relation(fields: [userId], references: [id])
  userId               Int
  month                Int
  year                 Int
  kpi1Attendance       Float @default(10)
  kpi2Timeliness       Float @default(10)
  kpi3InternalMeetings Float @default(10)
  kpi4ClientMeetings   Float @default(10)
  kpi5PeerReview       Float @default(10)
  kpi6Deadlines        Float @default(10)
  kpi7WeeklyReport     Float @default(10)
  kpi8ValueAdded       Float @default(0)
  kpi9Innovation       Float @default(0)
  totalScore           Float @default(0)
  bonusEarned          Float @default(0)
}
